<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Switchboard</title>
<style>
/* ── Brand Tokens ──────────────────────────────────────────────────────── */
:root {
  --bg:         #0B0D14;
  --surface:    #13161F;
  --surface-2:  #1A1E2B;
  --border:     #252A38;
  --border-2:   #303548;
  --text:       #E8EAF0;
  --muted:      #5C6278;
  --muted-2:    #8890A4;

  /* Status colors */
  --amber:      #F59E0B;
  --amber-dim:  #78490B;
  --green:      #22C55E;
  --green-dim:  #14532D;
  --blue:       #60A5FA;
  --blue-dim:   #1E3A5F;
  --purple:     #A78BFA;
  --purple-dim: #3B2A6B;
  --red:        #F87171;
  --red-dim:    #7F1D1D;
  --orange:     #FB923C;
  --orange-dim: #7C2D12;

  --col-inbox:    var(--muted-2);
  --col-todo:     var(--blue);
  --col-inprog:   var(--amber);
  --col-review:   var(--purple);
  --col-done:     var(--green);
  --col-failed:   var(--red);
  --col-blocked:  var(--orange);
}

/* ── Reset ─────────────────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
  font-size: 13px;
  line-height: 1.5;
  overflow-x: hidden;
  font-feature-settings: "cv02","cv03","cv04","tnum";
}
button { cursor: pointer; border: none; background: none; font: inherit; color: inherit; }
a { color: inherit; text-decoration: none; }

/* ── Logo SVG ──────────────────────────────────────────────────────────── */
.logo-mark { width: 28px; height: 28px; flex-shrink: 0; }

/* ── Header ────────────────────────────────────────────────────────────── */
header {
  height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-brand { display: flex; align-items: center; gap: 10px; }
.header-name {
  font-size: 15px;
  font-weight: 700;
  letter-spacing: -0.3px;
  color: var(--amber);
}
.header-tagline {
  font-size: 11px;
  color: var(--muted);
  display: none;
}
@media (min-width: 900px) { .header-tagline { display: block; } }

.header-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }

.header-stats {
  display: flex;
  gap: 14px;
  align-items: center;
}
.stat-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--muted-2);
}
.stat-val { font-weight: 600; color: var(--text); }

.header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.refresh-ts { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 4px; }

.btn-new {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--amber);
  color: #0B0D14;
  font-size: 12px;
  font-weight: 600;
  padding: 5px 12px;
  border-radius: 6px;
  transition: opacity 0.15s;
}
.btn-new:hover { opacity: 0.85; }

/* ── Agent Bar ─────────────────────────────────────────────────────────── */
.agent-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  min-height: 40px;
}
.agent-bar-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--muted);
  margin-right: 4px;
}
.agent-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px 3px 7px;
  font-size: 11px;
  font-weight: 500;
  transition: border-color 0.15s;
}
.agent-chip:hover { border-color: var(--border-2); }
.agent-status-icon {
  flex-shrink: 0;
  display: flex;
  align-items: center;
}
.dot-active  { color: var(--green); filter: drop-shadow(0 0 3px var(--green)); }
.dot-idle    { color: var(--amber); }
.dot-blocked { color: var(--red); }
.dot-offline { color: var(--muted); }
.agent-time  { color: var(--muted); font-size: 10px; }

/* ── Board Layout ──────────────────────────────────────────────────────── */
.board-wrap {
  padding: 16px 20px 80px;
  overflow-x: auto;
}
.board {
  display: grid;
  grid-template-columns: repeat(7, minmax(180px, 1fr));
  gap: 10px;
  min-width: 1300px;
}

/* ── Column ────────────────────────────────────────────────────────────── */
.col {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.col-head {
  padding: 10px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.col-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.7px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.col-badge {
  font-size: 11px;
  font-weight: 600;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 0 7px;
  color: var(--muted-2);
  min-width: 22px;
  text-align: center;
}

.col-inbox   .col-title { color: var(--col-inbox); }
.col-todo    .col-title { color: var(--col-todo); }
.col-in_progress .col-title { color: var(--col-inprog); }
.col-review  .col-title { color: var(--col-review); }
.col-done    .col-title { color: var(--col-done); }
.col-failed  .col-title { color: var(--col-failed); }
.col-blocked .col-title { color: var(--col-blocked); }

/* Color bar on col-head left edge via box-shadow */
.col-inbox   { box-shadow: inset 3px 0 0 var(--col-inbox); }
.col-todo    { box-shadow: inset 3px 0 0 var(--col-todo); }
.col-in_progress { box-shadow: inset 3px 0 0 var(--col-inprog); }
.col-review  { box-shadow: inset 3px 0 0 var(--col-review); }
.col-done    { box-shadow: inset 3px 0 0 var(--col-done); }
.col-failed  { box-shadow: inset 3px 0 0 var(--col-failed); }
.col-blocked { box-shadow: inset 3px 0 0 var(--col-blocked); }

.col-body {
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex: 1;
  overflow-y: auto;
  max-height: calc(100vh - 220px);
}

/* ── Task Card ─────────────────────────────────────────────────────────── */
.card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 7px;
  padding: 9px 11px;
  cursor: pointer;
  transition: border-color 0.15s, transform 0.1s, background 0.12s;
  position: relative;
}
.card:hover { border-color: var(--border-2); transform: translateY(-1px); }

/* Priority accent — left border */
.card[data-pri="urgent"] { border-left: 3px solid var(--red); }
.card[data-pri="high"]   { border-left: 3px solid var(--orange); }
.card[data-pri="normal"] { border-left: 3px solid var(--border); }
.card[data-pri="low"]    { border-left: 3px solid var(--muted); opacity: 0.8; }

.card-id {
  font-size: 10px;
  color: var(--muted);
  font-family: 'SF Mono', 'Fira Code', monospace;
}
.card-title {
  font-size: 12px;
  font-weight: 500;
  line-height: 1.4;
  margin-top: 3px;
  color: var(--text);
}
.card-desc {
  font-size: 11px;
  color: var(--muted-2);
  margin-top: 3px;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.card-foot {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
  flex-wrap: wrap;
}
.card-assignee {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: 500;
  color: var(--amber);
}
.card-assignee::before { content: '@'; opacity: 0.7; }
.card-time {
  margin-left: auto;
  font-size: 10px;
  color: var(--muted);
}
.card-empty {
  color: var(--muted);
  font-size: 11px;
  text-align: center;
  padding: 20px 8px;
  opacity: 0.6;
}

/* ── Messages Panel ────────────────────────────────────────────────────── */
.lines-panel {
  position: fixed;
  bottom: 0;
  right: 24px;
  width: 340px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 10px 10px 0 0;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
  z-index: 200;
  display: flex;
  flex-direction: column;
  max-height: 320px;
  transition: max-height 0.2s ease;
}
.lines-panel.collapsed { max-height: 42px; }
.lines-head {
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.lines-panel.collapsed .lines-head { border-bottom: none; }
.lines-head-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
}
.lines-badge {
  background: var(--red);
  color: white;
  font-size: 10px;
  font-weight: 700;
  border-radius: 10px;
  padding: 1px 6px;
}
.lines-toggle {
  margin-left: auto;
  color: var(--muted);
  display: flex;
  align-items: center;
}
.lines-body {
  overflow-y: auto;
  flex: 1;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.line-item {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 7px 10px;
  font-size: 11px;
  line-height: 1.4;
}
.line-item.unread { border-left: 2px solid var(--amber); }
.line-from { font-weight: 600; color: var(--amber); }
.line-to { color: var(--muted-2); }
.line-body { color: var(--text); margin-top: 2px; }
.line-time { color: var(--muted); font-size: 10px; margin-top: 3px; }
.lines-empty { color: var(--muted); text-align: center; padding: 16px 8px; font-size: 11px; }

/* ── Modal ─────────────────────────────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: 12px;
  width: 460px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  transform: translateY(8px);
  transition: transform 0.15s;
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal-head {
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-title { font-size: 14px; font-weight: 700; }
.modal-close {
  color: var(--muted);
  line-height: 1;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
}
.modal-close:hover { background: var(--surface-2); color: var(--text); }
.modal-body { padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 11px; font-weight: 600; color: var(--muted-2); text-transform: uppercase; letter-spacing: 0.5px; }
.form-input, .form-select, .form-textarea {
  background: var(--bg);
  border: 1px solid var(--border-2);
  border-radius: 6px;
  color: var(--text);
  font: inherit;
  font-size: 13px;
  padding: 8px 11px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  width: 100%;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--amber);
  box-shadow: 0 0 0 2px rgba(245,158,11,.25);
}
.form-textarea { resize: vertical; min-height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-foot {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.btn-cancel {
  padding: 7px 14px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  background: var(--surface-2);
  border: 1px solid var(--border);
  color: var(--muted-2);
  transition: background 0.15s;
}
.btn-cancel:hover { background: var(--border); }
.btn-submit {
  padding: 7px 16px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: var(--amber);
  color: #0B0D14;
  transition: opacity 0.15s;
}
.btn-submit:hover { opacity: 0.85; }

/* ── Detail Panel ──────────────────────────────────────────────────────── */
.detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 300;
  display: flex;
  align-items: stretch;
  justify-content: flex-end;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
}
.detail-overlay.open { opacity: 1; pointer-events: all; }
.detail-panel {
  width: 400px;
  max-width: 95vw;
  background: var(--surface);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transform: translateX(20px);
  transition: transform 0.15s;
  overflow-y: auto;
}
.detail-overlay.open .detail-panel { transform: translateX(0); }
.detail-head {
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.detail-id { font-size: 11px; font-family: monospace; color: var(--muted); }
.detail-close {
  margin-left: auto;
  color: var(--muted);
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
}
.detail-close:hover { background: var(--surface-2); color: var(--text); }
.detail-body { padding: 18px; display: flex; flex-direction: column; gap: 14px; flex: 1; }
.detail-title { font-size: 16px; font-weight: 700; line-height: 1.4; }
.detail-desc { font-size: 13px; color: var(--muted-2); line-height: 1.6; }
.detail-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.meta-item { display: flex; flex-direction: column; gap: 3px; }
.meta-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--muted); }
.meta-val { font-size: 12px; color: var(--text); font-weight: 500; }

/* ── Detail section headers ────────────────────────────────────────────── */
.detail-section-head {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-bottom: 5px;
}
.detail-section-head svg { flex-shrink: 0; }
.detail-section-head.context-head { color: var(--blue); }
.detail-section-head.output-head  { color: var(--green); }
.detail-section-head.review-head  { color: var(--purple); }

.detail-context { background: rgba(96,165,250,.07); border-left: 3px solid var(--blue); border-radius: 0 6px 6px 0; padding: 10px 12px; font-size: 12px; color: var(--muted-2); line-height: 1.6; white-space: pre-wrap; }
.detail-output  { background: rgba(34,197,94,.07);  border-left: 3px solid var(--green); border-radius: 0 6px 6px 0; padding: 10px 12px; font-size: 12px; color: var(--text); line-height: 1.6; white-space: pre-wrap; }
.detail-review  { background: rgba(167,139,250,.07);border-left: 3px solid var(--purple);border-radius: 0 6px 6px 0; padding: 10px 12px; font-size: 12px; color: var(--text); line-height: 1.6; white-space: pre-wrap; }

.detail-tags { display: flex; flex-wrap: wrap; gap: 5px; }
.tag-chip { background: rgba(245,158,11,.12); color: var(--amber); border-radius: 4px; padding: 2px 7px; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
.card-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
.iteration-badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  background: rgba(167,139,250,.15);
  color: var(--purple);
  border-radius: 4px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 4px;
}
.detail-msgs { margin-top: 4px; }
.detail-msgs-head { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--muted); margin-bottom: 8px; }
.detail-msg-item { background: var(--surface-2); border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; font-size: 12px; }
.detail-msg-from { font-weight: 600; color: var(--amber); }
.detail-msg-text { margin-top: 2px; color: var(--text); }
.detail-msg-time { margin-top: 2px; font-size: 10px; color: var(--muted); }

/* ── Status badges ─────────────────────────────────────────────────────── */
.badge {
  display: inline-flex;
  align-items: center;
  border-radius: 4px;
  padding: 2px 7px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}
.badge-inbox       { background: rgba(92,98,120,.25);  color: var(--muted-2); }
.badge-todo        { background: rgba(96,165,250,.15); color: var(--blue); }
.badge-in_progress { background: rgba(245,158,11,.15); color: var(--amber); }
.badge-review      { background: rgba(167,139,250,.15);color: var(--purple); }
.badge-done        { background: rgba(34,197,94,.15);  color: var(--green); }
.badge-failed      { background: rgba(248,113,113,.15);color: var(--red); }
.badge-blocked     { background: rgba(251,146,60,.15); color: var(--orange); }
.badge-pri-urgent  { background: rgba(248,113,113,.2); color: var(--red); }
.badge-pri-high    { background: rgba(251,146,60,.2);  color: var(--orange); }
.badge-pri-normal  { background: rgba(92,98,120,.2);   color: var(--muted-2); }
.badge-pri-low     { background: rgba(92,98,120,.15);  color: var(--muted); }

/* ── In-progress pulse ─────────────────────────────────────────────────── */
@keyframes pulse-ring {
  0%   { box-shadow: 0 0 0 0 rgba(245,158,11,.5); }
  70%  { box-shadow: 0 0 0 6px rgba(245,158,11,0); }
  100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); }
}
@keyframes spin { to { transform: rotate(360deg); } }
.card.working { border-color: var(--amber) !important; animation: pulse-ring 2s ease-out infinite; }
.card.working .card-title::before {
  content: '';
  display: inline-block;
  width: 7px; height: 7px;
  background: var(--amber);
  border-radius: 50%;
  margin-right: 6px;
  vertical-align: middle;
  animation: pulse-ring 1.4s ease-out infinite;
}

/* ── Scrollbar ─────────────────────────────────────────────────────────── */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }
</style>
</head>
<body>

<!-- ── Header ───────────────────────────────────────────────────────────── -->
<header>
  <div class="header-brand">
    <svg class="logo-mark" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Patch panel: 3x2 grid of jacks + one cable arc -->
      <rect width="28" height="28" rx="6" fill="#1A1E2B"/>
      <!-- Jacks -->
      <circle cx="8"  cy="10" r="2.5" fill="#252A38" stroke="#F59E0B" stroke-width="1.2"/>
      <circle cx="14" cy="10" r="2.5" fill="#252A38" stroke="#5C6278" stroke-width="1.2"/>
      <circle cx="20" cy="10" r="2.5" fill="#252A38" stroke="#5C6278" stroke-width="1.2"/>
      <circle cx="8"  cy="18" r="2.5" fill="#252A38" stroke="#5C6278" stroke-width="1.2"/>
      <circle cx="14" cy="18" r="2.5" fill="#252A38" stroke="#22C55E" stroke-width="1.2"/>
      <circle cx="20" cy="18" r="2.5" fill="#252A38" stroke="#F59E0B" stroke-width="1.2"/>
      <!-- Cable: amber jack top-left to green jack bottom-mid -->
      <path d="M8 12.5 C8 15.5 14 14.5 14 15.5" stroke="#F59E0B" stroke-width="1.4" stroke-linecap="round" fill="none"/>
      <!-- Cable: green bottom-mid to amber jack bottom-right -->
      <path d="M14 15.5 C14 16.5 20 16.5 20 15.5" stroke="#22C55E" stroke-width="1.4" stroke-linecap="round" fill="none"/>
      <!-- Center dot on active jacks -->
      <circle cx="8"  cy="10" r="1" fill="#F59E0B"/>
      <circle cx="14" cy="18" r="1" fill="#22C55E"/>
      <circle cx="20" cy="18" r="1" fill="#F59E0B"/>
    </svg>
    <span class="header-name">Switchboard</span>
    <span class="header-sep"></span>
    <span class="header-tagline">Route your agents. Run your fleet.</span>
  </div>

  <div class="header-stats" id="header-stats"></div>

  <div class="header-right">
    <span class="refresh-ts" id="refresh-ts">—</span>
    <button class="btn-new" onclick="openNewTask()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      New Task
    </button>
  </div>
</header>

<!-- ── Agent Bar ─────────────────────────────────────────────────────────── -->
<div class="agent-bar">
  <span class="agent-bar-label">Lines</span>
  <div id="agent-chips" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>
</div>

<!-- ── Board ─────────────────────────────────────────────────────────────── -->
<div class="board-wrap">
  <div class="board" id="board"></div>
</div>

<!-- ── Messages / Incoming Lines ─────────────────────────────────────────── -->
<div class="lines-panel" id="lines-panel">
  <div class="lines-head" onclick="toggleLines()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <span class="lines-head-label">Incoming Lines</span>
    <span class="lines-badge" id="lines-badge" style="display:none">0</span>
    <span class="lines-toggle" id="lines-toggle">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </span>
  </div>
  <div class="lines-body" id="lines-body"></div>
</div>

<!-- ── New Task Modal ─────────────────────────────────────────────────────── -->
<div class="modal-overlay" id="new-modal" onclick="handleModalBg(event)">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">New Task</span>
      <button class="modal-close" onclick="closeNewTask()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input class="form-input" id="f-title" placeholder="What needs doing?" autocomplete="off"/>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="f-desc" placeholder="Context, links, details…"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Assignee</label>
          <select class="form-select" id="f-assignee">
            <option value="">Unassigned</option>
            <option value="friday">friday</option>
            <option value="maeve">maeve</option>
            <option value="atlas">atlas</option>
            <option value="ops">ops</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="f-priority">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
            <option value="high">High</option>
            <option value="low">Low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="f-status">
            <option value="inbox">Inbox</option>
            <option value="todo">To Do</option>
            <option value="in_progress">In Progress</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Created By</label>
          <select class="form-select" id="f-created">
            <option value="friday">friday</option>
            <option value="maeve">maeve</option>
            <option value="atlas">atlas</option>
            <option value="ops">ops</option>
            <option value="human">human</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeNewTask()">Cancel</button>
      <button class="btn-submit" onclick="submitNewTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- ── Task Detail Slide-out ─────────────────────────────────────────────── -->
<div class="detail-overlay" id="detail-overlay" onclick="handleDetailBg(event)">
  <div class="detail-panel" id="detail-panel">
    <div class="detail-head">
      <div>
        <div class="detail-id" id="d-id"></div>
      </div>
      <button class="detail-close" onclick="closeDetail()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="detail-body">
      <div class="detail-title" id="d-title"></div>
      <div class="detail-desc" id="d-desc" style="display:none"></div>
      <div class="detail-tags" id="d-tags" style="display:none"></div>
      <div class="detail-meta" id="d-meta"></div>
      <div id="d-context" style="display:none">
        <div class="detail-section-head context-head">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Instructions
        </div>
        <div class="detail-context"></div>
      </div>
      <div id="d-output" style="display:none">
        <div class="detail-section-head output-head">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          Output
        </div>
        <div class="detail-output"></div>
      </div>
      <div id="d-review" style="display:none">
        <div class="detail-section-head review-head">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          Review
        </div>
        <div class="detail-review"></div>
      </div>
      <div class="detail-msgs" id="d-msgs"></div>
    </div>
  </div>
</div>

<script>
// ── State ─────────────────────────────────────────────────────────────────
let _board = null;
let _msgs  = [];
let _linesOpen = true;
let _activeTaskId = null;

const ITER_SVG = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>';

const COLS = [
  { key: 'inbox',       label: 'Inbox',       icon: '<path d="M22 12h-6l-2 3H10l-2-3H2"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>' },
  { key: 'todo',        label: 'To Do',       icon: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>' },
  { key: 'in_progress', label: 'In Progress', icon: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>' },
  { key: 'review',      label: 'Review',      icon: '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/>' },
  { key: 'done',        label: 'Done',        icon: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' },
  { key: 'failed',      label: 'Failed',      icon: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>' },
  { key: 'blocked',     label: 'Blocked',     icon: '<circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>' },
];

// ── Helpers ───────────────────────────────────────────────────────────────
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function ago(iso) {
  const s = Math.floor((Date.now() - new Date(iso)) / 1000);
  if (s < 5)   return 'just now';
  if (s < 60)  return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  if (s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}

function agentStatus(a) {
  const stale = Date.now() - new Date(a.last_heartbeat) > 5*60*1000;
  return stale ? 'offline' : (a.status || 'active');
}

// ── Fetch & Render ────────────────────────────────────────────────────────
async function refresh() {
  try {
    const [board, msgs] = await Promise.all([
      fetch('/board').then(r => r.json()),
      fetch('/messages?limit=40').then(r => r.json()),
    ]);
    _board = board;
    _msgs = msgs;
    renderAll();
    document.getElementById('refresh-ts').textContent = new Date().toLocaleTimeString();
  } catch(e) {
    document.getElementById('refresh-ts').innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Unreachable';
  }
}

function renderAll() {
  renderAgents();
  renderBoard();
  renderLines();
  renderHeaderStats();
  if (_activeTaskId) refreshDetail(_activeTaskId);
}

function renderHeaderStats() {
  const totals = _board?.totals || {};
  const active = (totals.in_progress || 0);
  const todo   = (totals.todo || 0) + (totals.inbox || 0);
  const done   = totals.done || 0;
  const agents = (_board?.agents || []).filter(a => agentStatus(a) === 'active').length;
  document.getElementById('header-stats').innerHTML = `
    <div class="stat-item"><span class="stat-val">${agents}</span> online</div>
    <div class="stat-item"><span class="stat-val">${active}</span> in progress</div>
    <div class="stat-item"><span class="stat-val">${todo}</span> queued</div>
    <div class="stat-item"><span class="stat-val">${done}</span> done</div>
  `;
}

function renderAgents() {
  const agents = _board?.agents || [];
  const chips = document.getElementById('agent-chips');
  if (!agents.length) {
    chips.innerHTML = '<span style="color:var(--muted);font-size:11px">No agents registered</span>';
    return;
  }
  chips.innerHTML = agents.map(a => {
    const status = agentStatus(a);
    const dotCls = status === 'active' ? 'dot-active' : status === 'idle' ? 'dot-idle' : status === 'blocked' ? 'dot-blocked' : 'dot-offline';
    const dotColor = status === 'active' ? 'var(--green)' : status === 'idle' ? 'var(--amber)' : status === 'blocked' ? 'var(--red)' : 'var(--muted)';
    return `<div class="agent-chip">
      <span class="agent-status-icon ${dotCls}"><svg width="8" height="8" viewBox="0 0 8 8" style="color:${dotColor}"><circle cx="4" cy="4" r="3" fill="currentColor"/></svg></span>
      <span>${esc(a.name)}</span>
      <span class="agent-time">${ago(a.last_heartbeat)}</span>
    </div>`;
  }).join('');
}

function renderBoard() {
  const tasks = _board?.tasks || {};
  document.getElementById('board').innerHTML = COLS.map(col => {
    const items = tasks[col.key] || [];
    const cards = items.length
      ? items.map(t => `
        <div class="card${t.status==='in_progress'?' working':''}" data-pri="${t.priority||'normal'}" data-id="${t.id}" onclick="openDetail(${t.id})">
          <div class="card-id">#${t.id}</div>
          <div class="card-title">${esc(t.title)}</div>
          ${t.description ? `<div class="card-desc">${esc(t.description)}</div>` : ''}
          ${t.tags && t.tags.length ? `<div class="card-tags">${t.tags.map(tg=>`<span class="tag-chip">${esc(tg)}</span>`).join('')}${t.iteration>0?`<span class="iteration-badge">${ITER_SVG} iter ${t.iteration}</span>`:''}</div>` : (t.iteration>0 ? `<div class="card-tags"><span class="iteration-badge">${ITER_SVG} iter ${t.iteration}</span></div>` : '')}
          <div class="card-foot">
            ${t.assignee ? `<span class="card-assignee">${esc(t.assignee)}</span>` : ''}
            <span class="card-time">${ago(t.updated_at)}</span>
          </div>
        </div>`).join('')
      : `<div class="card-empty">—</div>`;

    const colIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${col.icon}</svg>`;
    return `<div class="col col-${col.key}">
      <div class="col-head">
        <span class="col-title">${colIcon}${col.label}</span>
        <span class="col-badge">${items.length}</span>
      </div>
      <div class="col-body">${cards}</div>
    </div>`;
  }).join('');
}

function renderLines() {
  const unread = _board?.unread_messages || 0;
  const badge = document.getElementById('lines-badge');
  if (unread > 0) { badge.style.display = ''; badge.textContent = unread; }
  else badge.style.display = 'none';

  const body = document.getElementById('lines-body');
  if (!_msgs.length) {
    body.innerHTML = '<div class="lines-empty">No messages yet</div>';
    return;
  }
  body.innerHTML = [..._msgs].reverse().map(m => `
    <div class="line-item ${m.read ? '' : 'unread'}">
      <div>
        <span class="line-from">${esc(m.from_agent)}</span>
        ${m.to_agent ? `<span class="line-to"> → ${esc(m.to_agent)}</span>` : ''}
        ${m.task_id  ? `<span style="color:var(--muted)"> #${m.task_id}</span>` : ''}
      </div>
      <div class="line-body">${esc(m.content)}</div>
      <div class="line-time">${ago(m.created_at)}</div>
    </div>`).join('');
}

// ── Lines panel toggle ────────────────────────────────────────────────────
function toggleLines() {
  _linesOpen = !_linesOpen;
  document.getElementById('lines-panel').classList.toggle('collapsed', !_linesOpen);
  document.getElementById('lines-toggle').innerHTML = _linesOpen
    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>'
    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>';
}

// ── New Task Modal ────────────────────────────────────────────────────────
function openNewTask() {
  document.getElementById('new-modal').classList.add('open');
  document.getElementById('f-title').focus();
}
function closeNewTask() {
  document.getElementById('new-modal').classList.remove('open');
}
function handleModalBg(e) {
  if (e.target === document.getElementById('new-modal')) closeNewTask();
}
async function submitNewTask() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { document.getElementById('f-title').focus(); return; }
  const body = {
    title,
    description: document.getElementById('f-desc').value.trim(),
    assignee:    document.getElementById('f-assignee').value || null,
    priority:    document.getElementById('f-priority').value,
    status:      document.getElementById('f-status').value,
    created_by:  document.getElementById('f-created').value,
  };
  try {
    await fetch('/tasks', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    closeNewTask();
    document.getElementById('f-title').value = '';
    document.getElementById('f-desc').value = '';
    refresh();
  } catch(e) { alert('Failed to create task'); }
}

// ── Task Detail ───────────────────────────────────────────────────────────
async function openDetail(id) {
  _activeTaskId = id;
  document.getElementById('detail-overlay').classList.add('open');
  await refreshDetail(id);
}
async function refreshDetail(id) {
  try {
    const [task, msgs] = await Promise.all([
      fetch(`/tasks/${id}`).then(r => r.json()),
      fetch(`/messages?task_id=${id}&limit=20`).then(r => r.json()),
    ]);
    document.getElementById('d-id').textContent = `#${task.id}`;
    document.getElementById('d-title').textContent = task.title;
    const descEl = document.getElementById('d-desc');
    if (task.description) { descEl.style.display = ''; descEl.textContent = task.description; }
    else descEl.style.display = 'none';

    // Tags
    const tagsEl = document.getElementById('d-tags');
    if (task.tags && task.tags.length) {
      tagsEl.style.display = 'flex';
      tagsEl.innerHTML = task.tags.map(t => `<span class="tag-chip">${esc(t)}</span>`).join('');
    } else { tagsEl.style.display = 'none'; }

    // Context (instructions)
    const ctxWrap = document.getElementById('d-context');
    if (task.context) { ctxWrap.style.display = ''; ctxWrap.querySelector('.detail-context').textContent = task.context; }
    else ctxWrap.style.display = 'none';

    // Output (agent result)
    const outWrap = document.getElementById('d-output');
    if (task.output) { outWrap.style.display = ''; outWrap.querySelector('.detail-output').textContent = task.output; }
    else outWrap.style.display = 'none';

    // Review notes (QA feedback)
    const revWrap = document.getElementById('d-review');
    if (task.review_notes) { revWrap.style.display = ''; revWrap.querySelector('.detail-review').textContent = task.review_notes; }
    else revWrap.style.display = 'none';

    const iterBadge = task.iteration > 0 ? `<span class="iteration-badge">${ITER_SVG} iter ${task.iteration}</span>` : '';
    document.getElementById('d-meta').innerHTML = `
      <div class="meta-item"><span class="meta-label">Status</span>   <span class="meta-val"><span class="badge badge-${task.status}">${task.status.replace('_',' ')}</span>${iterBadge}</span></div>
      <div class="meta-item"><span class="meta-label">Priority</span>  <span class="meta-val"><span class="badge badge-pri-${task.priority}">${task.priority}</span></span></div>
      <div class="meta-item"><span class="meta-label">Assignee</span>  <span class="meta-val">${task.assignee ? '@'+task.assignee : '—'}</span></div>
      <div class="meta-item"><span class="meta-label">Created by</span><span class="meta-val">${task.created_by}</span></div>
      <div class="meta-item"><span class="meta-label">Created</span>   <span class="meta-val">${ago(task.created_at)}</span></div>
      <div class="meta-item"><span class="meta-label">Updated</span>   <span class="meta-val">${ago(task.updated_at)}</span></div>
    `;

    const msgsEl = document.getElementById('d-msgs');
    if (msgs.length) {
      msgsEl.innerHTML = `<div class="detail-msgs-head">Comments (${msgs.length})</div>` +
        msgs.map(m => `<div class="detail-msg-item">
          <div class="detail-msg-from">${esc(m.from_agent)}${m.to_agent?' → '+esc(m.to_agent):''}</div>
          <div class="detail-msg-text">${esc(m.content)}</div>
          <div class="detail-msg-time">${ago(m.created_at)}</div>
        </div>`).join('');
    } else {
      msgsEl.innerHTML = '';
    }
  } catch(e) {}
}
function closeDetail() {
  _activeTaskId = null;
  document.getElementById('detail-overlay').classList.remove('open');
}
function handleDetailBg(e) {
  if (e.target === document.getElementById('detail-overlay')) closeDetail();
}

// ── Auto-refresh ──────────────────────────────────────────────────────────
refresh();
setInterval(refresh, 15000);
</script>
</body>
</html>
